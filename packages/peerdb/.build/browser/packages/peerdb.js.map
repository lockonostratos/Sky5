{"version":3,"file":"\\packages\\peerdb.js","sources":["peerdb\\lib.coffee"],"names":[],"mappings":"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","sourcesContent":["globals = @\r\n\r\nRESERVED_FIELDS = ['document', 'parent', 'schema', 'migrations']\r\nINVALID_TARGET = \"Invalid target document\"\r\nMAX_RETRIES = 1000\r\n\r\nclass codeMinimizedTest\r\n\r\n@CODE_MINIMIZED = codeMinimizedTest.name and codeMinimizedTest.name isnt 'codeMinimizedTest'\r\n\r\nisPlainObject = (obj) ->\r\n  if not _.isObject(obj) or _.isArray(obj) or _.isFunction(obj)\r\n    return false\r\n\r\n  if obj.constructor isnt Object\r\n    return false\r\n\r\n  return true\r\n\r\ndeepExtend = (obj, args...) ->\r\n  _.each args, (source) ->\r\n    _.each source, (value, key) ->\r\n      if obj[key] and value and isPlainObject(obj[key]) and isPlainObject(value)\r\n        obj[key] = deepExtend obj[key], value\r\n      else\r\n        obj[key] = value\r\n  obj\r\n\r\nremoveUndefined = (obj) ->\r\n  assert isPlainObject obj\r\n\r\n  res = {}\r\n  for key, value of obj\r\n    if _.isUndefined value\r\n      continue\r\n    else if isPlainObject value\r\n      res[key] = removeUndefined value\r\n    else\r\n      res[key] = value\r\n  res\r\n\r\nstartsWith = (string, start) ->\r\n  string.lastIndexOf(start, 0) is 0\r\n\r\nremovePrefix = (string, prefix) ->\r\n  string.substring prefix.length\r\n\r\ngetCollection = (name, document, replaceParent) ->\r\n  transform = (doc) => new document doc\r\n\r\n  if _.isString(name)\r\n    if Document._collections[name]\r\n      methodHandlers = Document._collections[name]._connection.method_handlers or Document._collections[name]._connection._methodHandlers\r\n      for method of methodHandlers\r\n        if startsWith method, Document._collections[name]._prefix\r\n          if replaceParent\r\n            delete methodHandlers[method]\r\n          else\r\n            throw new Error \"Reuse of a collection without replaceParent set\"\r\n      if Document._collections[name]._connection.registerStore\r\n        if replaceParent\r\n          delete Document._collections[name]._connection._stores[name]\r\n        else\r\n          throw new Error \"Reuse of a collection without replaceParent set\"\r\n    collection = new Meteor.Collection name, transform: transform\r\n    Document._collections[name] = collection\r\n  else if name is null\r\n    collection = new Meteor.Collection name, transform: transform\r\n  else\r\n    collection = name\r\n    if collection._peerdb and not replaceParent\r\n      throw new Error \"Reuse of a collection without replaceParent set\"\r\n    collection._transform = LocalCollection.wrapTransform transform\r\n    collection._peerdb = true\r\n\r\n  collection\r\n\r\nclass globals.Document\r\n  # TODO: When we will require all fields to be specified and have validator support to validate new objects, we can also run validation here and check all data, reference fields and others\r\n  @objectify: (parent, ancestorArray, obj, fields) ->\r\n    throw new Error \"Document does not match schema, not a plain object\" unless isPlainObject obj\r\n\r\n    for name, field of fields\r\n      # Not all fields are necessary provided\r\n      continue unless obj[name]\r\n\r\n      path = if parent then \"#{ parent }.#{ name }\" else name\r\n\r\n      if field instanceof globals.Document._ReferenceField\r\n        throw new Error \"Document does not match schema, sourcePath does not match: #{ field.sourcePath } vs. #{ path }\" if field.sourcePath isnt path\r\n\r\n        if field.isArray\r\n          throw new Error \"Document does not match schema, not an array\" unless _.isArray obj[name]\r\n          obj[name] = _.map obj[name], (o) => new field.targetDocument o\r\n        else\r\n          throw new Error \"Document does not match schema, ancestorArray does not match: #{ field.ancestorArray } vs. #{ ancestorArray }\" if field.ancestorArray isnt ancestorArray\r\n          throw new Error \"Document does not match schema, not a plain object\" unless isPlainObject obj[name]\r\n          obj[name] = new field.targetDocument obj[name]\r\n\r\n      else if isPlainObject field\r\n        if _.isArray obj[name]\r\n          throw new Error \"Document does not match schema, an unexpected array\" unless _.some field, (f) => f.ancestorArray is path\r\n          throw new Error \"Document does not match schema, nested arrays are not supported\" if ancestorArray\r\n          obj[name] = _.map obj[name], (o) => @objectify path, path, o, field\r\n        else\r\n          throw new Error \"Document does not match schema, expected an array\" if _.some field, (f) => f.ancestorArray is path\r\n          obj[name] = @objectify path, ancestorArray, obj[name], field\r\n\r\n    obj\r\n\r\n  constructor: (doc) ->\r\n    _.extend @, @constructor.objectify '', null, (doc or {}), (@constructor?.Meta?.fields or {})\r\n\r\n  @_Trigger: class\r\n    constructor: (@fields, @trigger) ->\r\n      @fields ?= []\r\n\r\n    contributeToClass: (@document, @name) =>\r\n      @_metaLocation = @document.Meta._location\r\n      @collection = @document.Meta.collection\r\n\r\n    validate: =>\r\n      # TODO: Should these be simply asserts?\r\n      throw new Error \"Missing meta location\" unless @_metaLocation\r\n      throw new Error \"Missing name (from #{ @_metaLocation })\" unless @name\r\n      throw new Error \"Missing document (for #{ @name} trigger from #{ @_metaLocation })\" unless @document\r\n      throw new Error \"Missing collection (for #{ @name} trigger from #{ @_metaLocation })\" unless @collection\r\n      throw new Error \"Document not defined (for #{ @name} trigger from #{ @_metaLocation })\" unless @document.Meta._listIndex?\r\n\r\n      assert not @document.Meta._replaced\r\n      assert not @document.Meta._delayIndex?\r\n      assert.equal @document.Meta.document, @document\r\n      assert.equal @document.Meta.document.Meta, @document.Meta\r\n\r\n  @Trigger: (args...) ->\r\n    new @_Trigger args...\r\n\r\n  @_Field: class\r\n    contributeToClass: (@sourceDocument, @sourcePath, @ancestorArray) =>\r\n      @_metaLocation = @sourceDocument.Meta._location\r\n      @sourceCollection = @sourceDocument.Meta.collection\r\n\r\n    validate: =>\r\n      # TODO: Should these be simply asserts?\r\n      throw new Error \"Missing meta location\" unless @_metaLocation\r\n      throw new Error \"Missing source path (from #{ @_metaLocation })\" unless @sourcePath\r\n      throw new Error \"Missing source document (for #{ @sourcePath } from #{ @_metaLocation })\" unless @sourceDocument\r\n      throw new Error \"Missing source collection (for #{ @sourcePath } from #{ @_metaLocation })\" unless @sourceCollection\r\n      throw new Error \"Source document not defined (for #{ @sourcePath } from #{ @_metaLocation })\" unless @sourceDocument.Meta._listIndex?\r\n\r\n      assert not @sourceDocument.Meta._replaced\r\n      assert not @sourceDocument.Meta._delayIndex?\r\n      assert.equal @sourceDocument.Meta.document, @sourceDocument\r\n      assert.equal @sourceDocument.Meta.document.Meta, @sourceDocument.Meta\r\n\r\n  @_ObservingField: class extends @_Field\r\n\r\n  @_TargetedFieldsObservingField: class extends @_ObservingField\r\n    constructor: (targetDocument, @fields) ->\r\n      super()\r\n\r\n      @fields ?= []\r\n\r\n      if targetDocument is 'self'\r\n        @targetDocument = 'self'\r\n        @targetCollection = null\r\n      else if _.isFunction(targetDocument) and targetDocument.prototype instanceof globals.Document\r\n        @targetDocument = targetDocument\r\n        @targetCollection = targetDocument.Meta.collection\r\n      else\r\n        throw new Error INVALID_TARGET\r\n\r\n    contributeToClass: (sourceDocument, sourcePath, ancestorArray) =>\r\n      super sourceDocument, sourcePath, ancestorArray\r\n\r\n      if @targetDocument is 'self'\r\n        @targetDocument = @sourceDocument\r\n        @targetCollection = @sourceCollection\r\n\r\n      # Helpful values to know where and what the field is\r\n      @inArray = @ancestorArray and startsWith @sourcePath, @ancestorArray\r\n      @isArray = @ancestorArray and @sourcePath is @ancestorArray\r\n      @arraySuffix = removePrefix @sourcePath, @ancestorArray if @inArray\r\n\r\n    validate: =>\r\n      super()\r\n\r\n      throw new Error \"Missing target document (for #{ @sourcePath } from #{ @_metaLocation })\" unless @targetDocument\r\n      throw new Error \"Missing target collection (for #{ @sourcePath } from #{ @_metaLocation })\" unless @targetCollection\r\n      throw new Error \"Target document not defined (for #{ @sourcePath } from #{ @_metaLocation })\" unless @targetDocument.Meta._listIndex?\r\n\r\n      assert not @targetDocument.Meta._replaced\r\n      assert not @targetDocument.Meta._delayIndex?\r\n      assert.equal @targetDocument.Meta.document, @targetDocument\r\n      assert.equal @targetDocument.Meta.document.Meta, @targetDocument.Meta\r\n\r\n  @_ReferenceField: class extends @_TargetedFieldsObservingField\r\n    constructor: (targetDocument, fields, @required, @reverseName, @reverseFields) ->\r\n      super targetDocument, fields\r\n\r\n      @required ?= true\r\n      @reverseName ?= null\r\n      @reverseFields ?= []\r\n\r\n    contributeToClass: (sourceDocument, sourcePath, ancestorArray) =>\r\n      super sourceDocument, sourcePath, ancestorArray\r\n\r\n      throw new Error \"Reference field directly in an array cannot be optional (for #{ @sourcePath } from #{ @_metaLocation })\" if @ancestorArray and @sourcePath is @ancestorArray and not @required\r\n\r\n      return unless @reverseName\r\n\r\n      # We return now because contributeToClass will be retried sooner or later with replaced document again\r\n      return if @targetDocument.Meta._replaced\r\n\r\n      for reverse in @targetDocument.Meta._reverseFields\r\n        return if _.isEqual(reverse.reverseName, @reverseName) and _.isEqual(reverse.reverseFields, @reverseFields) and reverse.sourceDocument is @sourceDocument\r\n\r\n      @targetDocument.Meta._reverseFields.push @\r\n\r\n      # If target document is already defined, we queue it for a retry.\r\n      # We do not queue children, because or children replace a parent\r\n      # (and reverse fields will be defined there), or reference is\r\n      # pointing to this target document and we want reverse defined\r\n      # only once and only on exact target document and not its\r\n      # children.\r\n      if @targetDocument.Meta._listIndex?\r\n        globals.Document.list.splice @targetDocument.Meta._listIndex, 1\r\n\r\n        delete @targetDocument.Meta._replaced\r\n        delete @targetDocument.Meta._listIndex\r\n\r\n        # Renumber documents\r\n        for doc, i in globals.Document.list\r\n          doc.Meta._listIndex = i\r\n\r\n        globals.Document._addDelayed @targetDocument\r\n\r\n  @ReferenceField: (args...) ->\r\n    new @_ReferenceField args...\r\n\r\n  @_GeneratedField: class extends @_TargetedFieldsObservingField\r\n    constructor: (targetDocument, fields, @generator) ->\r\n      super targetDocument, fields\r\n\r\n  @GeneratedField: (args...) ->\r\n    new @_GeneratedField args...\r\n\r\n  @_Manager: class\r\n    constructor: (@meta) ->\r\n\r\n    find: (args...) =>\r\n      @meta.collection.find args...\r\n\r\n    findOne: (args...) =>\r\n      @meta.collection.findOne args...\r\n\r\n    insert: (args...) =>\r\n      @meta.collection.insert args...\r\n\r\n    update: (args...) =>\r\n      @meta.collection.update args...\r\n\r\n    upsert: (args...) =>\r\n      @meta.collection.upsert args...\r\n\r\n    remove: (args...) =>\r\n      @meta.collection.remove args...\r\n\r\n    exists: (query) =>\r\n      !!@meta.collection.findOne query,\r\n        fields:\r\n          _id: 1\r\n        transform: null\r\n\r\n  @_setDelayedCheck: ->\r\n    return unless globals.Document._delayed.length\r\n\r\n    @_clearDelayedCheck()\r\n\r\n    globals.Document._delayedCheckTimeout = Meteor.setTimeout ->\r\n      if globals.Document._delayed.length\r\n        delayed = [] # Display friendly list of delayed documents\r\n        for document in globals.Document._delayed\r\n          delayed.push \"#{ document.Meta._name } from #{ document.Meta._location }\"\r\n        Log.error \"Not all delayed document definitions were successfully retried:\\n#{ delayed.join('\\n') }\"\r\n    , 1000 # ms\r\n\r\n  @_clearDelayedCheck: ->\r\n    Meteor.clearTimeout globals.Document._delayedCheckTimeout if globals.Document._delayedCheckTimeout\r\n\r\n  @_processTriggers: (triggers) ->\r\n    assert triggers\r\n    assert isPlainObject triggers\r\n\r\n    for name, trigger of triggers\r\n      throw new Error \"Trigger names cannot contain '.' (for #{ name } trigger from #{ @Meta._location })\" if name.indexOf('.') isnt -1\r\n\r\n      if trigger instanceof globals.Document._Trigger\r\n        trigger.contributeToClass @, name\r\n      else\r\n        throw new Error \"Invalid value for trigger (for #{ name } trigger from #{ @Meta._location })\"\r\n\r\n    triggers\r\n\r\n  @_processFields: (fields, parent, ancestorArray) ->\r\n    assert fields\r\n    assert isPlainObject fields\r\n\r\n    ancestorArray = ancestorArray or null\r\n\r\n    res = {}\r\n    for name, field of fields\r\n      throw new Error \"Field names cannot contain '.' (for #{ name } from #{ @Meta._location })\" if name.indexOf('.') isnt -1\r\n\r\n      path = if parent then \"#{ parent }.#{ name }\" else name\r\n      array = ancestorArray\r\n\r\n      if _.isArray field\r\n        throw new Error \"Array field has to contain exactly one element, not #{ field.length } (for #{ path } from #{ @Meta._location })\" if field.length isnt 1\r\n        field = field[0]\r\n\r\n        if array\r\n          # TODO: Support nested arrays\r\n          # See: https://jira.mongodb.org/browse/SERVER-831\r\n          throw new Error \"Field cannot be in a nested array (for #{ path } from #{ @Meta._location })\"\r\n\r\n        array = path\r\n\r\n      if field instanceof globals.Document._Field\r\n        field.contributeToClass @, path, array\r\n        res[name] = field\r\n      else if _.isObject field\r\n        res[name] = @_processFields field, path, array\r\n      else\r\n        throw new Error \"Invalid value for field (for #{ path } from #{ @Meta._location })\"\r\n\r\n    res\r\n\r\n  @_fieldsUseDocument: (fields, document) ->\r\n    assert fields\r\n    assert isPlainObject fields\r\n\r\n    for name, field of fields\r\n      if field instanceof globals.Document._TargetedFieldsObservingField\r\n        return true if field.sourceDocument is document\r\n        return true if field.targetDocument is document\r\n      else if field instanceof globals.Document._Field\r\n        return true if field.sourceDocument is document\r\n      else\r\n        assert isPlainObject field\r\n        return true if @_fieldsUseDocument field, document\r\n\r\n    false\r\n\r\n  @_retryAllUsing: (document) ->\r\n    documents = globals.Document.list\r\n    globals.Document.list = []\r\n\r\n    for doc in documents\r\n      if @_fieldsUseDocument doc.Meta.fields, document\r\n        delete doc.Meta._replaced\r\n        delete doc.Meta._listIndex\r\n        @_addDelayed doc\r\n      else\r\n        globals.Document.list.push doc\r\n        doc.Meta._listIndex = globals.Document.list.length - 1\r\n\r\n  @_retryDelayed: (throwErrors) ->\r\n    @_clearDelayedCheck()\r\n\r\n    # We store the delayed list away, so that we can iterate over it\r\n    delayed = globals.Document._delayed\r\n    # And set it back to the empty list, we will add to it again as necessary\r\n    globals.Document._delayed = []\r\n\r\n    for document in delayed\r\n      delete document.Meta._delayIndex\r\n\r\n    processedCount = 0\r\n\r\n    for document in delayed\r\n      assert not document.Meta._listIndex?\r\n\r\n      if document.Meta._replaced\r\n        continue\r\n\r\n      try\r\n        triggers = document.Meta._triggers.call document, {}\r\n        if triggers and isPlainObject triggers\r\n          document.Meta.triggers = document._processTriggers triggers\r\n      catch e\r\n        if not throwErrors and (e.message is INVALID_TARGET or e instanceof ReferenceError)\r\n          @_addDelayed document\r\n          continue\r\n        else\r\n          throw new Error \"Invalid triggers (from #{ document.Meta._location }): #{ e.stringOf?() or e }\\n---#{ if e.stack then \"#{ e.stack }\\n---\" else '' }\"\r\n\r\n      throw new Error \"No triggers returned (from #{ document.Meta._location })\" unless triggers\r\n      throw new Error \"Returned triggers should be a plain object (from #{ document.Meta._location })\" unless isPlainObject triggers\r\n\r\n      try\r\n        fields = document.Meta._fields.call document, {}\r\n        if fields and isPlainObject fields\r\n          # We run _processFields first, so that _reverseFields for this document is populated as well\r\n          document._processFields fields\r\n\r\n          reverseFields = {}\r\n          for reverse in document.Meta._reverseFields\r\n            reverseFields[reverse.reverseName] = [globals.Document.ReferenceField reverse.sourceDocument, reverse.reverseFields]\r\n\r\n          # And now we run _reverseFields for real on all fields\r\n          document.Meta.fields = document._processFields _.extend fields, reverseFields\r\n      catch e\r\n        if not throwErrors and (e.message is INVALID_TARGET or e instanceof ReferenceError)\r\n          @_addDelayed document\r\n          continue\r\n        else\r\n          throw new Error \"Invalid fields (from #{ document.Meta._location }): #{ e.stringOf?() or e }\\n---#{ if e.stack then \"#{ e.stack }\\n---\" else '' }\"\r\n\r\n      throw new Error \"No fields returned (from #{ document.Meta._location })\" unless fields\r\n      throw new Error \"Returned fields should be a plain object (from #{ document.Meta._location })\" unless isPlainObject fields\r\n\r\n      if document.Meta.replaceParent and not document.Meta.parent?._replaced\r\n        throw new Error \"Replace parent set, but no parent known (from #{ document.Meta._location })\" unless document.Meta.parent\r\n\r\n        document.Meta.parent._replaced = true\r\n\r\n        if document.Meta.parent._listIndex?\r\n          globals.Document.list.splice document.Meta.parent._listIndex, 1\r\n          delete document.Meta.parent._listIndex\r\n\r\n          # Renumber documents\r\n          for doc, i in globals.Document.list\r\n            doc.Meta._listIndex = i\r\n\r\n        else if document.Meta.parent._delayIndex?\r\n          globals.Document._delayed.splice document.Meta.parent._delayIndex, 1\r\n          delete document.Meta.parent._delayIndex\r\n\r\n          # Renumber documents\r\n          for doc, i in globals.Document._delayed\r\n            doc.Meta._delayIndex = i\r\n\r\n        @_retryAllUsing document.Meta.parent.document\r\n\r\n      globals.Document.list.push document\r\n      document.Meta._listIndex = globals.Document.list.length - 1\r\n      delete document.Meta._delayIndex\r\n\r\n      assert not document.Meta._replaced\r\n\r\n      processedCount++\r\n\r\n    @_setDelayedCheck()\r\n\r\n    processedCount\r\n\r\n  @_addDelayed: (document) ->\r\n    @_clearDelayedCheck()\r\n\r\n    assert not document.Meta._replaced\r\n    assert not document.Meta._listIndex?\r\n\r\n    globals.Document._delayed.push document\r\n    document.Meta._delayIndex = globals.Document._delayed.length - 1\r\n\r\n    @_setDelayedCheck()\r\n\r\n  @_validateTriggers: (document) ->\r\n    for name, trigger of document.Meta.triggers\r\n      if trigger instanceof globals.Document._Trigger\r\n        trigger.validate()\r\n      else\r\n        throw new Error \"Invalid trigger (for #{ name } trigger from #{ document.Meta._location })\"\r\n\r\n  @_validateFields: (obj) ->\r\n    for name, field of obj\r\n      if field instanceof globals.Document._Field\r\n        field.validate()\r\n      else\r\n        @_validateFields field\r\n\r\n  @Meta: (meta) ->\r\n    for field in RESERVED_FIELDS or startsWith field, '_'\r\n      throw \"Reserved meta field name: #{ field }\" if field of meta\r\n\r\n    if meta.abstract\r\n      throw new Error \"name cannot be set in abstract document\" if meta.name\r\n      throw new Error \"replaceParent cannot be set in abstract document\" if meta.replaceParent\r\n      throw new Error \"Abstract document with a parent\" if @Meta._name\r\n    else\r\n      throw new Error \"Missing document name\" unless meta.name\r\n      throw new Error \"Document name does not match class name\" if not CODE_MINIMIZED and @name and @name isnt meta.name\r\n      throw new Error \"replaceParent set without a parent\" if meta.replaceParent and not @Meta._name\r\n\r\n    name = meta.name\r\n    currentTriggers = meta.triggers or (ts) -> ts\r\n    currentFields = meta.fields or (fs) -> fs\r\n    meta = _.omit meta, 'name', 'triggers', 'fields'\r\n\r\n    parentMeta = @Meta\r\n\r\n    if parentMeta._triggers\r\n      triggers = (ts) ->\r\n        newTs = parentMeta._triggers ts\r\n        removeUndefined _.extend ts, newTs, currentTriggers newTs\r\n    else\r\n      triggers = currentTriggers\r\n\r\n    meta._triggers = triggers # Triggers function\r\n\r\n    if parentMeta._fields\r\n      fields = (fs) ->\r\n        newFs = parentMeta._fields fs\r\n        removeUndefined deepExtend fs, newFs, currentFields newFs\r\n    else\r\n      fields = currentFields\r\n\r\n    meta._fields = fields # Fields function\r\n\r\n    if not meta.abstract\r\n      meta._name = name # \"name\" is a reserved property name on functions in some environments (eg. node.js), so we use \"_name\"\r\n      # For easier debugging and better error messages\r\n      meta._location = if CODE_MINIMIZED then '<code_minimized>' else StackTrace.getCaller()\r\n      meta.document = @\r\n\r\n      if meta.collection is null or meta.collection\r\n        meta.collection = getCollection meta.collection, @, meta.replaceParent\r\n      else if parentMeta.collection?._peerdb\r\n        meta.collection = getCollection parentMeta.collection, @, meta.replaceParent\r\n      else\r\n        meta.collection = getCollection \"#{ name }s\", @, meta.replaceParent\r\n\r\n      if @Meta._name\r\n        meta.parent = parentMeta\r\n\r\n      if not meta.replaceParent\r\n        # If we are not replacing the parent, we override _reverseFields with an empty set\r\n        # because we want reverse fields only on exact target document and not its children.\r\n        meta._reverseFields = []\r\n      else\r\n        meta._reverseFields = _.clone parentMeta._reverseFields\r\n\r\n      if not meta.replaceParent\r\n        # If we are not replacing the parent, we create a new list of migrations\r\n        meta.migrations = []\r\n\r\n    clonedParentMeta = -> parentMeta.apply @, arguments\r\n    filteredParentMeta = _.omit parentMeta, '_listIndex', '_delayIndex', '_replaced', 'parent', 'replaceParent', 'abstract'\r\n    @Meta = _.extend clonedParentMeta, filteredParentMeta, meta\r\n\r\n    if not meta.abstract\r\n      assert @Meta._reverseFields\r\n\r\n      @documents = new @_Manager @Meta\r\n\r\n      @_addDelayed @\r\n      @_retryDelayed()\r\n\r\n  @list = []\r\n  @_delayed = []\r\n  @_delayedCheckTimeout = null\r\n  @_collections = {}\r\n\r\n  @validateAll: ->\r\n    for document in globals.Document.list\r\n      throw new Error \"Missing fields (from #{ document.Meta._location })\" unless document.Meta.fields\r\n      @_validateTriggers document\r\n      @_validateFields document.Meta.fields\r\n\r\n  @defineAll: (dontThrowDelayedErrors) ->\r\n    for i in [0..MAX_RETRIES]\r\n      if i is MAX_RETRIES\r\n        throw new Error \"Possible infinite loop\" unless dontThrowDelayedErrors\r\n        break\r\n\r\n      globals.Document._retryDelayed not dontThrowDelayedErrors\r\n\r\n      break unless globals.Document._delayed.length\r\n\r\n    globals.Document.validateAll()\r\n\r\n    assert dontThrowDelayedErrors or globals.Document._delayed.length is 0\r\n\r\nDocument = globals.Document\r\n\r\nassert globals.Document._ReferenceField.prototype instanceof globals.Document._TargetedFieldsObservingField\r\nassert globals.Document._GeneratedField.prototype instanceof globals.Document._TargetedFieldsObservingField\r\n"]}